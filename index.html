<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Park Maths!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Chalkboard SE', 'Chalkboard', 'Arial Rounded MT Bold', 'Trebuchet MS', 'Comic Sans MS', Arial, sans-serif;
            overflow: hidden;
            background: #87CEEB;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Menu Styles */
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            overflow-y: auto;
            padding: 20px 0;
        }

        #menu h1 {
            font-size: 4rem;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes carShake {
            0%   { margin-left: 0; }
            15%  { margin-left: -8px; }
            30%  { margin-left: 8px; }
            45%  { margin-left: -6px; }
            60%  { margin-left: 6px; }
            75%  { margin-left: -3px; }
            90%  { margin-left: 3px; }
            100% { margin-left: 0; }
        }

        #player-car.shake {
            animation: carShake 0.4s ease-out;
        }

        .menu-box {
            background: white;
            border-radius: 20px;
            padding: 30px 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            border: 5px solid #FFD700;
            width: calc(100% - 40px);
            max-width: 680px;
        }

        .menu-box h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .option-group {
            margin: 15px 0;
        }

        .option-group label {
            display: block;
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 8px;
        }

        .option-group select, .option-group input {
            font-size: 1.2rem;
            padding: 10px 20px;
            border-radius: 10px;
            border: 3px solid #667eea;
            font-family: inherit;
            cursor: pointer;
        }

        .option-group select:focus, .option-group input:focus {
            outline: none;
            border-color: #FFD700;
        }

        /* Name Input Section */
        .name-section {
            margin: 20px 0;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 15px;
            border: 3px dashed #667eea;
        }

        .name-section label {
            font-size: 1.3rem;
            color: #333;
            display: block;
            margin-bottom: 10px;
        }

        .name-display {
            font-size: 2rem;
            color: #764ba2;
            font-weight: bold;
            min-height: 50px;
            background: white;
            border-radius: 10px;
            padding: 10px 50px 10px 20px;
            margin-bottom: 10px;
            border: 3px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .name-display > span:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .name-display .clear-name {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #FF6B6B;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .name-display .clear-name:hover {
            background: #EE5A5A;
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
            width: 100%;
            max-width: 580px;
            margin: 0 auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .key {
            flex: 1;
            min-width: 36px;
            max-width: 54px;
            height: 45px;
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            border: 2px solid #999;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 3px 0 #999;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .key:hover {
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
        }

        .key:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #999;
        }

        .key.backspace {
            flex: 1.5;
            max-width: 81px;
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%);
            color: white;
            border-color: #CC4444;
            box-shadow: 0 3px 0 #CC4444;
        }

        .key.backspace:active {
            box-shadow: 0 0 0 #CC4444;
        }

        #start-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            padding: 20px 60px;
            font-size: 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            color: #764ba2;
            font-weight: bold;
            box-shadow: 0 6px 0 #CC8400, 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 20px;
        }

        #start-btn:hover {
            transform: scale(1.05);
        }

        #start-btn:active {
            transform: scale(0.98);
            box-shadow: 0 3px 0 #CC8400, 0 5px 10px rgba(0,0,0,0.2);
        }

        .top-score {
            margin-top: 20px;
            font-size: 1.5rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
        }

        /* Game Styles */
        #game {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #carpark-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-linear-gradient(
                    90deg,
                    #555 0px,
                    #555 2px,
                    #666 2px,
                    #666 100px
                ),
                repeating-linear-gradient(
                    0deg,
                    #555 0px,
                    #555 2px,
                    #666 2px,
                    #666 60px
                ),
                #444;
        }

        .parking-space {
            position: absolute;
            background: rgba(255, 255, 255, 0.22);
            border: 5px dashed rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s;
        }

        .parking-space:hover {
            background: rgba(255, 255, 255, 0.38);
            transform: scale(1.05);
        }

        .parking-space .number {
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.6);
        }

        #player-car {
            position: absolute;
            transition: transform 0.5s ease-out, left 0.5s ease-out, top 0.5s ease-out;
            z-index: 50;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.4));
        }

        #question-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 20px 50px;
            border-radius: 20px;
            border: 5px solid white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 60;
        }

        #question-text {
            font-size: 3rem;
            font-weight: bold;
            color: #764ba2;
            text-shadow: 2px 2px 0 white;
        }

        #score-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            border-radius: 15px;
            border: 4px solid #FFD700;
            z-index: 60;
        }

        #score-display span {
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        #score-value {
            font-size: 2rem;
            color: #FFD700;
        }

        @keyframes feedbackPop {
            0%   { transform: translate(-50%, -50%) scale(0); }
            60%  { transform: translate(-50%, -50%) scale(1.25); }
            80%  { transform: translate(-50%, -50%) scale(0.92); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        #feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 7rem;
            z-index: 70;
            pointer-events: none;
        }

        #feedback.show {
            animation: feedbackPop 0.35s ease-out forwards;
        }

        #feedback.correct {
            color: #00FF00;
            text-shadow: 4px 4px 0 #006400, -2px -2px 0 #006400;
        }

        #feedback.wrong {
            color: #FF0000;
            text-shadow: 4px 4px 0 #8B0000, -2px -2px 0 #8B0000;
        }

        #quit-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%);
            border: none;
            padding: 12px 22px;
            font-size: 1.3rem;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #AA2222, 0 6px 15px rgba(0,0,0,0.25);
            z-index: 60;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #quit-btn:hover { transform: scale(1.05); }
        #quit-btn:active { transform: scale(0.97); box-shadow: 0 2px 0 #AA2222; }

        #timer-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%);
            padding: 15px 30px;
            border-radius: 15px;
            border: 4px solid #FFD700;
            z-index: 60;
        }

        #timer-display span {
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        #timer-value {
            font-size: 2rem;
            color: #FFD700;
        }

        /* Splash Screen */
        #splash-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        #splash-screen h2 {
            font-size: 5rem;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            margin-bottom: 30px;
            animation: bounce 0.5s ease infinite;
        }

        #splash-screen .final-score {
            font-size: 3rem;
            color: white;
            margin-bottom: 40px;
        }

        #splash-screen .final-score span {
            color: #FFD700;
            font-size: 4rem;
        }

        #splash-screen .buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #play-again-btn, #menu-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            padding: 20px 60px;
            font-size: 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            color: #764ba2;
            font-weight: bold;
            box-shadow: 0 6px 0 #CC8400, 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #play-again-btn:hover, #menu-btn:hover {
            transform: scale(1.05);
        }

        #play-again-btn:active, #menu-btn:active {
            transform: scale(0.98);
            box-shadow: 0 3px 0 #CC8400, 0 5px 10px rgba(0,0,0,0.2);
        }

        #menu-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 0 #5566cc, 0 10px 20px rgba(0,0,0,0.2);
        }

        #menu-btn:active {
            box-shadow: 0 3px 0 #5566cc, 0 5px 10px rgba(0,0,0,0.2);
        }

        /* Cloud decorations */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.8;
        }

        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }

        .cloud-1 { width: 100px; height: 40px; top: 80px; left: 10%; }
        .cloud-1::before { width: 50px; height: 50px; top: -25px; left: 15px; }
        .cloud-1::after { width: 40px; height: 40px; top: -15px; left: 45px; }

        .cloud-2 { width: 80px; height: 35px; top: 120px; right: 15%; }
        .cloud-2::before { width: 40px; height: 40px; top: -20px; left: 10px; }
        .cloud-2::after { width: 35px; height: 35px; top: -12px; left: 35px; }

        .cloud-3 { width: 120px; height: 45px; top: 60px; right: 30%; }
        .cloud-3::before { width: 60px; height: 60px; top: -30px; left: 20px; }
        .cloud-3::after { width: 50px; height: 50px; top: -20px; left: 55px; }


        /* Help Button */
        #help-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            padding: 12px 22px;
            font-size: 1.3rem;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            color: #764ba2;
            font-weight: bold;
            box-shadow: 0 4px 0 #CC8400, 0 6px 15px rgba(0,0,0,0.25);
            z-index: 60;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #help-btn:hover { transform: scale(1.05); }
        #help-btn:active { transform: scale(0.97); box-shadow: 0 2px 0 #CC8400; }

        /* Help Overlay */
        #help-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.72);
            z-index: 150;
            align-items: center;
            justify-content: center;
        }
        #help-content {
            background: white;
            border-radius: 24px;
            padding: 40px 40px 30px;
            max-width: min(620px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            text-align: center;
            border: 5px solid #FFD700;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        }
        #help-close {
            position: absolute;
            top: 12px; right: 12px;
            width: 46px; height: 46px;
            border-radius: 50%;
            background: #FF4444;
            color: white;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.15s;
        }
        #help-close:hover { background: #CC2222; }
        #help-question-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 24px;
        }
        #help-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .help-hint {
            font-size: 1.2rem;
            color: #555;
            margin-top: 6px;
            padding: 10px 20px;
            background: #f0f4ff;
            border-radius: 10px;
        }


        /* ‚îÄ‚îÄ Settings button (main menu) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 20px 60px;
            font-size: 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #4455cc, 0 6px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 12px;
        }
        #settings-btn:hover { transform: scale(1.05); }
        #settings-btn:active { transform: scale(0.97); box-shadow: 0 2px 0 #4455cc; }

        /* ‚îÄ‚îÄ Settings overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #settings-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }
        #settings-content {
            background: white;
            border-radius: 24px;
            padding: 40px 50px 35px;
            max-width: min(560px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            text-align: left;
            border: 5px solid #667eea;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        }
        #settings-content h2 {
            font-size: 2rem;
            color: #764ba2;
            margin-bottom: 4px;
            text-align: center;
        }
        .settings-subtitle {
            font-size: 1rem;
            color: #888;
            text-align: center;
            margin-bottom: 24px;
        }
        .settings-group {
            margin: 16px 0;
        }
        .settings-group > label:not(.checkbox-label) {
            display: block;
            font-size: 1.2rem;
            color: #333;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .settings-group select {
            font-size: 1.1rem;
            padding: 10px 16px;
            border-radius: 10px;
            border: 3px solid #667eea;
            font-family: inherit;
            cursor: pointer;
            width: 100%;
        }
        .settings-group select:focus { outline: none; border-color: #FFD700; }
        #number-bonds-group {
            display: none;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 14px 16px;
            background: #f8f8ff;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            width: 26px;
            height: 26px;
            cursor: pointer;
            accent-color: #667eea;
        }
        .settings-description {
            font-size: 0.95rem;
            color: #555;
            margin-top: 10px;
            margin-left: 38px;
            line-height: 1.7;
            background: #eef1ff;
            border-radius: 10px;
            padding: 10px 14px;
        }
        #settings-close {
            position: absolute;
            top: 12px; right: 12px;
            width: 46px; height: 46px;
            border-radius: 50%;
            background: #FF4444;
            color: white;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        #settings-close:hover { background: #CC2222; }
        #settings-save-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 16px;
            font-size: 1.4rem;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #4455cc;
            transition: transform 0.1s, box-shadow 0.1s;
            margin-top: 24px;
        }
        #settings-save-btn:hover { transform: scale(1.02); }
        #settings-save-btn:active { transform: scale(0.98); box-shadow: 0 2px 0 #4455cc; }

        /* Compact vertical spacing for tablets in landscape / short viewports */
        @media (max-height: 850px) {
            #menu h1 { font-size: 2.8rem; margin-bottom: 8px; }
            .menu-box { padding: 18px 40px; }
            .menu-box h2 { font-size: 1.4rem; margin-bottom: 8px; }
            .option-group { margin: 7px 0; }
            .option-group label { font-size: 1.1rem; margin-bottom: 4px; }
            .option-group select, .option-group input { font-size: 1rem; padding: 7px 14px; }
            .name-section { margin: 8px 0; padding: 10px; }
            .name-section label { margin-bottom: 6px; font-size: 1.1rem; }
            .name-display { font-size: 1.5rem; min-height: 40px; padding: 7px 45px 7px 16px; margin-bottom: 8px; }
            .key { height: 36px; font-size: 1rem; }
            #start-btn { font-size: 1.6rem; padding: 13px 48px; margin-top: 10px; }
            .top-score { margin-top: 10px; font-size: 1.2rem; }
        }

        /* Small phones */
        @media (max-width: 550px) {
            #menu h1 { font-size: 2.5rem; margin-bottom: 12px; }
            .menu-box { padding: 20px 25px; }
            .menu-box h2 { font-size: 1.4rem; margin-bottom: 12px; }
            .option-group { margin: 10px 0; }
            .option-group label { font-size: 1.1rem; }
            .option-group select, .option-group input { font-size: 1rem; padding: 8px 14px; }
            #start-btn { font-size: 1.5rem; padding: 15px 40px; }
            #question-text { font-size: 2rem; }
            #question-box { padding: 15px 30px; }
            .key { height: 38px; font-size: 1rem; }
            .name-display { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Menu Screen -->
        <div id="menu">
            <h1>üöó Car Park Maths! üöó</h1>
            <div class="menu-box">
                <h2>Choose Your Game</h2>

                <div class="name-section">
                    <label>Who is playing?</label>
                    <div class="name-display">
                        <span id="player-name">Click keys below</span>
                        <button class="clear-name" id="clear-name-btn" title="Clear name">√ó</button>
                    </div>
                    <div class="keyboard" id="keyboard"></div>
                </div>

                <button id="start-btn">START! üèÅ</button>
                <button id="settings-btn">‚öôÔ∏è Settings</button>

                <div class="top-score">
                    üèÜ Best Score: <span id="best-score">0</span>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game">
            <div id="carpark-bg">
                <div class="cloud cloud-1"></div>
                <div class="cloud cloud-2"></div>
                <div class="cloud cloud-3"></div>
            </div>

            <div id="question-box">
                <span id="question-text">5 + 3 = ?</span>
            </div>

            <div id="timer-display" style="display: none;">
                <span>Time: <span id="timer-value">0:00</span></span>
            </div>

            <div id="score-display">
                <span>Score: <span id="score-value">0</span></span>
            </div>

            <img id="player-car" src="player-car.png" alt="Player Car">

            <div id="feedback"></div>

            <button id="help-btn">üí° Help!</button>

            <div id="help-overlay">
                <div id="help-content">
                    <button id="help-close">‚úï</button>
                    <div id="help-question-display"></div>
                    <div id="help-diagram"></div>
                </div>
            </div>

            <button id="quit-btn">üè† Menu</button>
        </div>

        <!-- Splash Screen -->
        <div id="splash-screen">
            <h2>üåü Well Done! üåü</h2>
            <div class="final-score">Your Score: <span id="final-score-value">0</span></div>
            <div class="buttons">
                <button id="play-again-btn">Play Again! üéÆ</button>
                <button id="menu-btn">Main Menu üè†</button>
            </div>
        </div>
    </div>

        <!-- Settings Overlay -->
        <div id="settings-overlay">
            <div id="settings-content">
                <button id="settings-close">‚úï</button>
                <h2>‚öôÔ∏è Settings</h2>
                <p class="settings-subtitle">Set up the game for your child</p>

                <div class="settings-group">
                    <label for="s-operation">What to practise?</label>
                    <select id="s-operation">
                        <option value="addition">Addition (+)</option>
                        <option value="subtraction">Subtraction (‚àí)</option>
                        <option value="multiplication">Multiplication (√ó)</option>
                        <option value="division">Division (√∑)</option>
                        <option value="addition_subtraction">Addition and Subtraction</option>
                    </select>
                </div>

                <div class="settings-group" id="number-bonds-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="s-number-bonds">
                        <span>Number Bonds</span>
                    </label>
                    <p class="settings-description">
                        Questions ask for the missing number to reach the target.<br>
                        e.g. with target 10: <strong>7 + ? = 10</strong> &nbsp;or&nbsp; <strong>? + 3 = 10</strong>
                    </p>
                </div>

                <div class="settings-group">
                    <label for="s-max-number">Biggest number to use:</label>
                    <select id="s-max-number">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                        <option value="60">60</option>
                        <option value="70">70</option>
                        <option value="80">80</option>
                        <option value="90">90</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label for="s-timer">Time limit:</label>
                    <select id="s-timer">
                        <option value="0">No time limit</option>
                        <option value="60">1 minute</option>
                        <option value="120">2 minutes</option>
                        <option value="180">3 minutes</option>
                    </select>
                </div>

                <button id="settings-save-btn">Save Settings ‚úì</button>
            </div>
        </div>


    <script>
        // Game State
        let score = 0;
        let currentAnswer = 0;
        let isAnimating = false;
        let parkingSpaces = [];
        const maxSpaces = 10;
        let gameTimer = null;
        let timeRemaining = 0;
        let timerEnabled = false;
        let playerName = '';
        let currentNum1 = 0;
        let currentNum2 = 0;
        let currentOperation = '';
        let numberBondsMode = false;

        // Persisted game settings (loaded from localStorage)
        let gameSettings = {
            operation: 'addition',
            maxNumber: 20,
            timer: 0,
            numberBonds: false
        };

        // Responsive sizing based on viewport
        function getResponsiveSizes() {
            const minDimension = Math.min(window.innerWidth, window.innerHeight);
            const scale = minDimension / 800; // Base scale on 800px minimum dimension
            
            return {
                spaceWidth: Math.floor(187 * scale), // Reduced by 25% from 250
                spaceHeight: Math.floor(112 * scale), // Reduced by 25% from 150
                carWidth: Math.floor(200 * scale),
                carHeight: Math.floor(125 * scale),
                numberFontSize: `${Math.floor(3 * scale)}rem`,
                minSpacing: Math.floor(225 * scale) // Reduced by 25% from 300
            };
        }

        // DOM Elements
        const menu = document.getElementById('menu');
        const game = document.getElementById('game');
        const startBtn = document.getElementById('start-btn');
        const bestScoreDisplay = document.getElementById('best-score');
        const questionText = document.getElementById('question-text');
        const scoreValue = document.getElementById('score-value');
        const playerCar = document.getElementById('player-car');
        const carparkBg = document.getElementById('carpark-bg');
        const feedback = document.getElementById('feedback');
        const timerDisplay = document.getElementById('timer-display');
        const timerValue = document.getElementById('timer-value');
        const splashScreen = document.getElementById('splash-screen');
        const finalScoreValue = document.getElementById('final-score-value');
        const playAgainBtn = document.getElementById('play-again-btn');
        const menuBtn = document.getElementById('menu-btn');
        const playerNameDisplay = document.getElementById('player-name');
        const clearNameBtn = document.getElementById('clear-name-btn');
        const keyboard = document.getElementById('keyboard');

        // Load best score from localStorage
        function loadBestScore() {
            const best = localStorage.getItem('carParkMathsBestScore') || 0;
            bestScoreDisplay.textContent = best;
        }

        // Save best score to localStorage
        function saveBestScore() {
            const currentBest = localStorage.getItem('carParkMathsBestScore') || 0;
            if (score > currentBest) {
                localStorage.setItem('carParkMathsBestScore', score);
            }
        }

        // Load player name from localStorage
        function loadPlayerName() {
            playerName = localStorage.getItem('carParkMathsPlayerName') || '';
            updateNameDisplay();
        }

        // Save player name to localStorage
        function savePlayerName() {
            localStorage.setItem('carParkMathsPlayerName', playerName);
        }

        // Update name display
        function updateNameDisplay() {
            if (playerName.length === 0) {
                playerNameDisplay.textContent = 'Click keys below';
                clearNameBtn.style.display = 'none';
            } else {
                playerNameDisplay.textContent = playerName;
                clearNameBtn.style.display = 'flex';
            }
        }

        // Create on-screen keyboard
        function createKeyboard() {
            const rows = [
                'QWERTYUIOP'.split(''),
                'ASDFGHJKL'.split(''),
                'ZXCVBNM'.split('')
            ];

            rows.forEach((rowLetters, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';

                rowLetters.forEach(letter => {
                    const key = document.createElement('button');
                    key.className = 'key';
                    key.textContent = letter;
                    key.addEventListener('click', () => addLetter(letter));
                    rowDiv.appendChild(key);
                });

                if (rowIndex === 2) {
                    const backspace = document.createElement('button');
                    backspace.className = 'key backspace';
                    backspace.textContent = '‚å´';
                    backspace.addEventListener('click', removeLetter);
                    rowDiv.appendChild(backspace);
                }

                keyboard.appendChild(rowDiv);
            });
        }

        // Add letter to name
        function addLetter(letter) {
            if (playerName.length < 12) {
                playerName += letter;
                savePlayerName();
                updateNameDisplay();
            }
        }

        // Remove letter from name
        function removeLetter() {
            playerName = playerName.slice(0, -1);
            savePlayerName();
            updateNameDisplay();
        }

        // Clear name
        function clearName() {
            playerName = '';
            savePlayerName();
            updateNameDisplay();
        }

        // Generate a math question
        // Generate a math question
        function generateQuestion() {
            const operation = gameSettings.operation;
            const maxNum = gameSettings.maxNumber;

            // Number bonds mode: find the missing addend to reach the target
            numberBondsMode = gameSettings.numberBonds &&
                (operation === 'addition' || operation === 'addition_subtraction');

            if (numberBondsMode) {
                const target = maxNum;
                const known = Math.floor(Math.random() * (target - 1)) + 1; // 1 ‚Ä¶ target-1
                currentAnswer = target - known;
                currentNum1 = known;
                currentNum2 = currentAnswer;
                currentOperation = 'number_bonds';

                // Format depends on chosen operation
                if (operation === 'addition') {
                    // Addition bonds: always show as + equation
                    if (Math.random() < 0.5) {
                        questionText.textContent = `${known} + ? = ${target}`;
                    } else {
                        questionText.textContent = `? + ${known} = ${target}`;
                    }
                } else {
                    // Addition & Subtraction bonds: mix all four formats
                    const fmt = Math.floor(Math.random() * 4);
                    if (fmt === 0) questionText.textContent = `${known} + ? = ${target}`;
                    else if (fmt === 1) questionText.textContent = `? + ${known} = ${target}`;
                    else if (fmt === 2) questionText.textContent = `${target} ‚àí ${known} = ?`;
                    else questionText.textContent = `${target} ‚àí ? = ${known}`;
                }
                return;
            }

            let num1, num2, symbol;
            switch(operation) {
                case 'addition':
                    num1 = Math.floor(Math.random() * maxNum) + 1;
                    num2 = Math.floor(Math.random() * maxNum) + 1;
                    currentAnswer = num1 + num2;
                    symbol = '+';
                    break;
                case 'subtraction':
                    num1 = Math.floor(Math.random() * maxNum) + 5;
                    num2 = Math.floor(Math.random() * num1) + 1;
                    currentAnswer = num1 - num2;
                    symbol = '‚àí';
                    break;
                case 'addition_subtraction':
                    if (Math.random() < 0.5) {
                        num1 = Math.floor(Math.random() * maxNum) + 1;
                        num2 = Math.floor(Math.random() * maxNum) + 1;
                        currentAnswer = num1 + num2;
                        symbol = '+';
                    } else {
                        num1 = Math.floor(Math.random() * maxNum) + 5;
                        num2 = Math.floor(Math.random() * num1) + 1;
                        currentAnswer = num1 - num2;
                        symbol = '‚àí';
                    }
                    break;
                case 'multiplication':
                    const maxMult = Math.min(maxNum, 12);
                    num1 = Math.floor(Math.random() * maxMult) + 1;
                    num2 = Math.floor(Math.random() * Math.min(maxNum / num1, 12)) + 1;
                    currentAnswer = num1 * num2;
                    symbol = '√ó';
                    break;
                case 'division':
                    num2 = Math.floor(Math.random() * 9) + 2; // 2‚Äì10
                    currentAnswer = Math.floor(Math.random() * Math.max(Math.min(Math.floor(maxNum / num2), 10), 4)) + 1;
                    num1 = currentAnswer * num2;
                    symbol = '√∑';
                    break;
            }

            questionText.textContent = `${num1} ${symbol} ${num2} = ?`;
            currentNum1 = num1;
            currentNum2 = num2;
            if (symbol === '+') currentOperation = 'addition';
            else if (symbol === '‚àí') currentOperation = 'subtraction';
            else if (symbol === '√ó') currentOperation = 'multiplication';
            else currentOperation = 'division';
        }

        // Check if two rectangles overlap
        function rectanglesOverlap(x1, y1, w1, h1, x2, y2, w2, h2) {
            const gap = 18; // minimum clear gap between spaces
            return !(x1 + w1 + gap < x2 ||
                     x2 + w2 + gap < x1 ||
                     y1 + h1 + gap < y2 ||
                     y2 + h2 + gap < y1);
        }

        // Generate parking spaces with numbers
        function generateParkingSpaces() {
            document.querySelectorAll('.parking-space').forEach(el => el.remove());
            parkingSpaces = [];

            const sizes = getResponsiveSizes();
            const gameRect = game.getBoundingClientRect();
            const spaceWidth = sizes.spaceWidth;
            const spaceHeight = sizes.spaceHeight;
            const edgePad = 30;
            const minY = 150;
            const maxY = gameRect.height - spaceHeight - edgePad;
            const maxX = gameRect.width - spaceWidth - edgePad;

            // Car starting zone (bottom-left) ‚Äî keep spaces clear of it
            const carStartZone = {
                x: 0,
                y: gameRect.height - sizes.carHeight - 100,
                width: 300,
                height: sizes.carHeight + 100
            };

            // placedSpaces stores top-left (x, y) ‚Äî no center conversion needed
            const placedSpaces = [];

            function overlapsAny(x, y) {
                if (rectanglesOverlap(x, y, spaceWidth, spaceHeight,
                        carStartZone.x, carStartZone.y,
                        carStartZone.width, carStartZone.height)) return true;
                for (const p of placedSpaces) {
                    if (rectanglesOverlap(x, y, spaceWidth, spaceHeight,
                            p.x, p.y, spaceWidth, spaceHeight)) return true;
                }
                return false;
            }

            // Generate unique distractor numbers alongside the correct answer
            const numbers = new Set();
            numbers.add(currentAnswer);
            if (numberBondsMode) {
                // Distractors span 0..target so every value in the bond range appears
                const target = gameSettings.maxNumber;
                while (numbers.size < maxSpaces && numbers.size < target + 1) {
                    const randomNum = Math.floor(Math.random() * (target + 1));
                    if (randomNum !== currentAnswer) numbers.add(randomNum);
                }
            } else {
                while (numbers.size < maxSpaces) {
                    const randomNum = Math.floor(Math.random() * Math.max(currentAnswer * 2, 20)) + 1;
                    if (randomNum !== currentAnswer) numbers.add(randomNum);
                }
            }
            const numbersArray = Array.from(numbers).sort(() => Math.random() - 0.5);

            for (let i = 0; i < numbersArray.length; i++) {
                let x, y, placed = false;

                // Phase 1: random attempts
                for (let attempt = 0; attempt < 500 && !placed; attempt++) {
                    x = edgePad + Math.random() * (maxX - edgePad);
                    y = minY + Math.random() * (maxY - minY);
                    if (!overlapsAny(x, y)) placed = true;
                }

                // Phase 2: systematic grid scan as fallback
                if (!placed) {
                    const stepX = spaceWidth + 20;
                    const stepY = spaceHeight + 20;
                    outer: for (let gy = minY; gy <= maxY; gy += stepY) {
                        for (let gx = edgePad; gx <= maxX; gx += stepX) {
                            if (!overlapsAny(gx, gy)) {
                                x = gx; y = gy; placed = true;
                                break outer;
                            }
                        }
                    }
                }

                // No room at all ‚Äî skip rather than place on top of another space
                if (!placed) continue;

                placedSpaces.push({ x, y });

                const space = document.createElement('div');
                space.className = 'parking-space';
                space.style.width = spaceWidth + 'px';
                space.style.height = spaceHeight + 'px';
                space.style.left = x + 'px';
                space.style.top = y + 'px';

                const numberSpan = document.createElement('span');
                numberSpan.className = 'number';
                numberSpan.textContent = numbersArray[i];
                numberSpan.style.fontSize = sizes.numberFontSize;
                space.appendChild(numberSpan);

                space.addEventListener('click', () => handleSpaceClick(space, numbersArray[i]));
                space.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    handleSpaceClick(space, numbersArray[i]);
                });

                carparkBg.appendChild(space);
                parkingSpaces.push({
                    element: space,
                    number: numbersArray[i],
                    x: x + spaceWidth / 2,
                    y: y + spaceHeight / 2
                });
            }
        }

        // Handle parking space click
        function handleSpaceClick(spaceElement, number) {
            if (isAnimating) return;

            const space = parkingSpaces.find(s => s.element === spaceElement);
            if (!space) return;

            // Calculate rotation angle
            const carRect = playerCar.getBoundingClientRect();
            const carX = carRect.left + carRect.width / 2;
            const carY = carRect.top + carRect.height / 2;

            const angle = Math.atan2(space.y - carY, space.x - carX) * 180 / Math.PI;

            // Rotate car to face the space (car image faces right, so 0 degrees is correct)
            playerCar.style.transform = `rotate(${angle}deg)`;

            isAnimating = true;

            // Move car to the space
            const sizes = getResponsiveSizes();
            setTimeout(() => {
                playerCar.style.left = (space.x - sizes.carWidth / 2) + 'px';
                playerCar.style.top = (space.y - sizes.carHeight / 2) + 'px';
            }, 50);

            // Check answer after animation
            setTimeout(() => {
                if (Number(number) === currentAnswer) {
                    // Correct!
                    score++;
                    scoreValue.textContent = score;
                    showFeedback(true);

                    setTimeout(() => {
                        resetForNextQuestion();
                    }, 800);
                } else {
                    // Wrong! ‚Äî shake the car, then re-enable after a short debounce
                    showFeedback(false);
                    playerCar.classList.remove('shake');
                    void playerCar.offsetWidth; // force reflow to restart animation
                    playerCar.classList.add('shake');
                    setTimeout(() => {
                        playerCar.classList.remove('shake');
                        isAnimating = false;
                    }, 400);
                }
            }, 550);
        }

        // Show feedback (tick or cross)
        function showFeedback(isCorrect) {
            feedback.textContent = isCorrect ? '‚úì' : '‚úó';
            feedback.className = isCorrect ? 'correct show' : 'wrong show';

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 1000);
        }

        // Reset for next question
        function resetForNextQuestion() {
            generateQuestion();
            generateParkingSpaces();

            // Reset car position to bottom left
            const sizes = getResponsiveSizes();
            const gameRect = game.getBoundingClientRect();
            playerCar.style.left = '50px';
            playerCar.style.top = (gameRect.height - sizes.carHeight - 50) + 'px';
            playerCar.style.transform = 'rotate(0deg)';

            isAnimating = false;
        }

        // Timer functions
        function startTimer() {
            const timerSeconds = gameSettings.timer;
            if (timerSeconds > 0) {
                timerEnabled = true;
                timeRemaining = timerSeconds;
                timerDisplay.style.display = 'block';
                updateTimerDisplay();

                gameTimer = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();

                    if (timeRemaining <= 0) {
                        endGame();
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerValue.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Change color and pulse when time is running low
            if (timeRemaining <= 10) {
                timerDisplay.style.background = 'linear-gradient(135deg, #FF0000 0%, #CC0000 100%)';
                timerDisplay.style.animation = 'timerPulse 0.5s ease infinite';
            } else {
                timerDisplay.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%)';
                timerDisplay.style.animation = '';
            }
        }

        function stopTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            timerEnabled = false;
            timerDisplay.style.display = 'none';
        }

        // End game and show splash screen
        function endGame() {
            stopTimer();
            saveBestScore();
            finalScoreValue.textContent = score;
            splashScreen.style.display = 'flex';
        }

        // Apply responsive sizes
        function applyResponsiveSizes() {
            const sizes = getResponsiveSizes();
            playerCar.style.width = sizes.carWidth + 'px';
            playerCar.style.height = sizes.carHeight + 'px';
        }

        // Start game
        function startGame() {
            score = 0;
            scoreValue.textContent = score;
            menu.style.display = 'none';
            game.style.display = 'block';
            splashScreen.style.display = 'none';

            // Apply responsive sizes
            applyResponsiveSizes();

            // Initialize car position
            const sizes = getResponsiveSizes();
            const gameRect = game.getBoundingClientRect();
            playerCar.style.left = '50px';
            playerCar.style.top = (gameRect.height - sizes.carHeight - 50) + 'px';

            generateQuestion();
            generateParkingSpaces();
            startTimer();
        }

        // Return to menu
        function returnToMenu() {
            stopTimer();
            saveBestScore();
            loadBestScore();
            splashScreen.style.display = 'none';
            game.style.display = 'none';
            menu.style.display = 'flex';
        }


        // Pause/resume timer for help overlay
        function pauseTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }

        function resumeTimer() {
            if (timerEnabled && timeRemaining > 0 && !gameTimer) {
                gameTimer = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    if (timeRemaining <= 0) endGame();
                }, 1000);
            }
        }

        // ‚îÄ‚îÄ Help overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const helpBtn = document.getElementById('help-btn');
        const helpOverlay = document.getElementById('help-overlay');
        const helpClose = document.getElementById('help-close');
        const helpQuestionDisplay = document.getElementById('help-question-display');
        const helpDiagram = document.getElementById('help-diagram');

        function makeDotGroup(count, color, dotSize, dotsPerRow) {
            dotsPerRow = dotsPerRow || 5;
            const g = document.createElement('div');
            g.style.display = 'flex';
            g.style.flexWrap = 'wrap';
            g.style.gap = '5px';
            g.style.justifyContent = 'flex-start';
            g.style.maxWidth = (dotsPerRow * dotSize + (dotsPerRow - 1) * 5) + 'px';
            for (let i = 0; i < count; i++) {
                const d = document.createElement('div');
                d.style.cssText = `width:${dotSize}px;height:${dotSize}px;border-radius:50%;background:${color};flex-shrink:0`;
                g.appendChild(d);
            }
            return g;
        }

        function buildHelpDiagram() {
            helpDiagram.innerHTML = '';
            const n1 = currentNum1;
            const n2 = currentNum2;
            const ans = currentAnswer;
            const op = currentOperation;

            const hint = document.createElement('div');
            hint.className = 'help-hint';

            if (op === 'addition') {
                const sz = (n1 + n2) <= 20 ? 28 : (n1 + n2) <= 40 ? 22 : 16;

                const row = document.createElement('div');
                row.style.cssText = 'display:flex;align-items:flex-start;gap:16px;justify-content:center;flex-wrap:wrap';

                // Group 1 (purple)
                const g1 = document.createElement('div');
                g1.style.textAlign = 'center';
                const g1lbl = document.createElement('div');
                g1lbl.textContent = n1;
                g1lbl.style.cssText = 'font-size:1.8rem;font-weight:bold;color:#764ba2;margin-bottom:8px';
                g1.appendChild(g1lbl);
                g1.appendChild(makeDotGroup(n1, '#764ba2', sz));

                // + symbol
                const plus = document.createElement('div');
                plus.textContent = '+';
                plus.style.cssText = 'font-size:3rem;font-weight:bold;color:#333;align-self:center;padding-top:30px';

                // Group 2 (green)
                const g2 = document.createElement('div');
                g2.style.textAlign = 'center';
                const g2lbl = document.createElement('div');
                g2lbl.textContent = n2;
                g2lbl.style.cssText = 'font-size:1.8rem;font-weight:bold;color:#4CAF50;margin-bottom:8px';
                g2.appendChild(g2lbl);
                g2.appendChild(makeDotGroup(n2, '#4CAF50', sz));

                row.appendChild(g1);
                row.appendChild(plus);
                row.appendChild(g2);
                helpDiagram.appendChild(row);
                hint.textContent = 'Count ALL the dots to find the answer! üü£üü¢';

            } else if (op === 'subtraction') {
                const sz = n1 <= 20 ? 28 : n1 <= 40 ? 22 : 16;
                const COLS = 5;

                const grid = document.createElement('div');
                grid.style.cssText = `display:flex;flex-wrap:wrap;gap:5px;justify-content:center;max-width:${COLS * sz + (COLS - 1) * 5}px;margin:0 auto`;

                for (let i = 0; i < n1; i++) {
                    const d = document.createElement('div');
                    // First 'ans' dots are "kept" (dark purple), rest are "taken away" (red)
                    d.style.cssText = `width:${sz}px;height:${sz}px;border-radius:50%;flex-shrink:0;background:${i < ans ? '#764ba2' : '#FF6B6B'}`;
                    grid.appendChild(d);
                }
                helpDiagram.appendChild(grid);

                const legend = document.createElement('div');
                legend.style.cssText = 'display:flex;gap:20px;justify-content:center;flex-wrap:wrap;margin-top:8px;font-size:1.1rem';
                legend.innerHTML = `
                    <span><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#764ba2;vertical-align:middle;margin-right:5px"></span>Keep these (${ans})</span>
                    <span><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#FF6B6B;vertical-align:middle;margin-right:5px"></span>Take away (${n2})</span>
                `;
                helpDiagram.appendChild(legend);
                hint.textContent = 'Count only the purple dots! üíú';

            } else if (op === 'multiplication') {
                const totalDots = n1 * n2;
                if (totalDots > 60) {
                    const msg = document.createElement('div');
                    msg.style.cssText = 'font-size:1.1rem;color:#555;margin:10px 0;line-height:1.9';
                    msg.innerHTML = `<strong>${n1} rows</strong> of <strong>${n2} dots</strong><br>= ${totalDots} dots total<br><br>Ask a grown-up to help you draw it! ‚úèÔ∏è`;
                    helpDiagram.appendChild(msg);
                } else {
                    const sz = totalDots <= 30 ? 26 : 20;
                    const ROW_COLORS = ['#764ba2','#667eea','#4CAF50','#FF9800','#FF6B6B','#00BCD4','#E91E63','#795548','#607D8B','#9C27B0','#F44336','#2196F3'];
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin:0 auto';

                    for (let r = 0; r < n1; r++) {
                        const rowDiv = document.createElement('div');
                        rowDiv.style.cssText = 'display:flex;gap:5px;align-items:center';
                        const lbl = document.createElement('span');
                        lbl.textContent = `${r + 1}.`;
                        lbl.style.cssText = 'font-size:0.85rem;color:#999;width:22px;text-align:right;flex-shrink:0';
                        rowDiv.appendChild(lbl);
                        for (let c = 0; c < n2; c++) {
                            const d = document.createElement('div');
                            d.style.cssText = `width:${sz}px;height:${sz}px;border-radius:50%;background:${ROW_COLORS[r % ROW_COLORS.length]};flex-shrink:0`;
                            rowDiv.appendChild(d);
                        }
                        wrapper.appendChild(rowDiv);
                    }
                    helpDiagram.appendChild(wrapper);
                }
                hint.textContent = `${n1} rows of ${n2} dots ‚Äî count them all! üî¢`;

            } else if (op === 'division') {
                if (n1 > 60 || n2 > 10) {
                    const msg = document.createElement('div');
                    msg.style.cssText = 'font-size:1.1rem;color:#555;margin:10px 0;line-height:1.9';
                    msg.innerHTML = `Share <strong>${n1}</strong> dots equally into <strong>${n2}</strong> groups<br><br>Ask a grown-up to help you! ‚úèÔ∏è`;
                    helpDiagram.appendChild(msg);
                } else {
                    const sz = ans <= 5 ? 28 : ans <= 10 ? 22 : 18;
                    const GROUP_COLORS = ['#764ba2','#667eea','#4CAF50','#FF9800','#FF6B6B','#00BCD4','#E91E63','#795548','#607D8B','#9C27B0'];
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'display:flex;flex-wrap:wrap;gap:12px;justify-content:center';

                    for (let g = 0; g < n2; g++) {
                        const color = GROUP_COLORS[g % GROUP_COLORS.length];
                        const box = document.createElement('div');
                        box.style.cssText = `border:3px solid ${color};border-radius:14px;padding:10px 12px;display:flex;flex-direction:column;align-items:center;gap:6px;min-width:60px`;
                        const glbl = document.createElement('div');
                        glbl.textContent = `${g + 1}`;
                        glbl.style.cssText = `font-size:0.85rem;font-weight:bold;color:${color}`;
                        box.appendChild(glbl);
                        box.appendChild(makeDotGroup(ans, color, sz, 3));
                        wrapper.appendChild(box);
                    }
                    helpDiagram.appendChild(wrapper);
                }
                hint.textContent = `${n1} dots shared into ${n2} equal groups ‚Äî how many in each? üî¢`;

            } else if (op === 'number_bonds') {
                const target = n1 + ans; // known + missing = target
                const sz = target <= 20 ? 26 : target <= 40 ? 20 : 14;
                const COLS = Math.min(10, target);
                const grid = document.createElement('div');
                grid.style.cssText = `display:flex;flex-wrap:wrap;gap:5px;justify-content:center;max-width:${COLS * sz + (COLS - 1) * 5}px;margin:0 auto`;
                for (let i = 0; i < target; i++) {
                    const d = document.createElement('div');
                    d.style.cssText = `width:${sz}px;height:${sz}px;border-radius:50%;flex-shrink:0;background:${i < n1 ? '#764ba2' : '#4CAF50'}`;
                    grid.appendChild(d);
                }
                helpDiagram.appendChild(grid);
                const legend = document.createElement('div');
                legend.style.cssText = 'display:flex;gap:20px;justify-content:center;flex-wrap:wrap;margin-top:8px;font-size:1.1rem';
                legend.innerHTML = `
                    <span><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#764ba2;vertical-align:middle;margin-right:5px"></span>You have: ${n1}</span>
                    <span><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#4CAF50;vertical-align:middle;margin-right:5px"></span>Missing: ?</span>
                `;
                helpDiagram.appendChild(legend);
                hint.textContent = `Count the green dots to find what‚Äôs missing! üíö`;
            }

            helpDiagram.appendChild(hint);
        }

        function showHelp() {
            pauseTimer();
            helpQuestionDisplay.textContent = questionText.textContent;
            buildHelpDiagram();
            helpOverlay.style.display = 'flex';
        }

        function closeHelp() {
            helpOverlay.style.display = 'none';
            resumeTimer();
        }


        // ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadSettings() {
            const saved = localStorage.getItem('carParkMathsSettings');
            if (saved) {
                try { Object.assign(gameSettings, JSON.parse(saved)); } catch(e) {}
            }
        }

        function saveSettings() {
            gameSettings.operation  = document.getElementById('s-operation').value;
            gameSettings.maxNumber  = parseInt(document.getElementById('s-max-number').value);
            gameSettings.timer      = parseInt(document.getElementById('s-timer').value);
            gameSettings.numberBonds = document.getElementById('s-number-bonds').checked;
            localStorage.setItem('carParkMathsSettings', JSON.stringify(gameSettings));
        }

        function updateNumberBondsVisibility() {
            const op = document.getElementById('s-operation').value;
            const showNB = (op === 'addition' || op === 'addition_subtraction');
            const nbGroup = document.getElementById('number-bonds-group');
            nbGroup.style.display = showNB ? 'block' : 'none';
            if (!showNB) document.getElementById('s-number-bonds').checked = false;
        }

        function populateSettingsUI() {
            document.getElementById('s-operation').value   = gameSettings.operation;
            document.getElementById('s-max-number').value  = gameSettings.maxNumber;
            document.getElementById('s-timer').value       = gameSettings.timer;
            document.getElementById('s-number-bonds').checked = gameSettings.numberBonds;
            updateNumberBondsVisibility();
        }

        function showSettings() {
            populateSettingsUI();
            document.getElementById('settings-overlay').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-overlay').style.display = 'none';
        }

        // Event Listeners
        startBtn.addEventListener('click', startGame);
        playAgainBtn.addEventListener('click', () => {
            splashScreen.style.display = 'none';
            startGame();
        });
        menuBtn.addEventListener('click', returnToMenu);
        clearNameBtn.addEventListener('click', clearName);
        helpBtn.addEventListener('click', showHelp);
        helpClose.addEventListener('click', closeHelp);
        helpOverlay.addEventListener('click', (e) => { if (e.target === helpOverlay) closeHelp(); });

        document.getElementById('quit-btn').addEventListener('click', returnToMenu);
        document.getElementById('settings-btn').addEventListener('click', showSettings);
        document.getElementById('settings-close').addEventListener('click', closeSettings);
        document.getElementById('settings-save-btn').addEventListener('click', () => { saveSettings(); closeSettings(); });
        document.getElementById('settings-overlay').addEventListener('click', e => { if (e.target === document.getElementById('settings-overlay')) closeSettings(); });
        document.getElementById('s-operation').addEventListener('change', updateNumberBondsVisibility);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'q' || e.key === 'Q') {
                if (game.style.display !== 'none') {
                    returnToMenu();
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (game.style.display !== 'none') {
                applyResponsiveSizes();
                const sizes = getResponsiveSizes();
                const gameRect = game.getBoundingClientRect();
                playerCar.style.top = (gameRect.height - sizes.carHeight - 50) + 'px';
                generateParkingSpaces();
            }
        });

        // Initialize
        loadSettings();
        loadBestScore();
        loadPlayerName();
        createKeyboard();
    </script>
</body>
</html>
